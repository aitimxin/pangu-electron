# 视频抓取重试逻辑修改说明

## 修改日期
2025-11-06

## 修改内容

### 1. 添加重试机制
在 `puppeteerService.js` 的 `fetchVideo` 方法中添加了最多3次重试的逻辑。

### 2. 移除降级后端抓取
不再降级到后端抓取，失败后直接重试前端抓取。

## 具体实现

### 重试逻辑
- **最大重试次数**: 3次
- **重试延迟**: 递增延迟（第1次失败后等待2秒，第2次失败后等待4秒）
- **进度反馈**: 每次尝试都会通过 progressCallback 向用户反馈当前状态

### 代码位置
- 文件: `pangu-electron/electron/services/puppeteerService.js`
- 方法: `fetchVideo(url, progressCallback)`
- 行数: 70-164

## 工作流程

```
开始抓取
  ↓
检查缓存
  ↓
第1次尝试
  ├─ 成功 → 返回结果
  └─ 失败 → 等待2秒
       ↓
     第2次尝试
       ├─ 成功 → 返回结果
       └─ 失败 → 等待4秒
            ↓
          第3次尝试
            ├─ 成功 → 返回结果
            └─ 失败 → 抛出错误（已重试3次）
```

## 错误处理

### 重试过程中
- 自动清理失败的页面资源
- 记录详细的错误日志
- 向用户显示重试进度

### 最终失败
- 抛出错误信息：`视频抓取失败（已重试 3 次）: [具体错误]`
- 用户收到明确的失败提示

## 用户体验改进

1. **透明的重试过程**: 用户可以看到每次尝试的进度
2. **智能延迟**: 避免快速连续请求导致的封禁
3. **详细的错误信息**: 失败时提供完整的错误说明
4. **资源管理**: 及时清理失败的页面，避免内存泄漏

## 测试建议

### 正常场景
1. 测试正常的视频抓取（第1次即成功）
2. 验证缓存机制仍然正常工作

### 异常场景
1. 测试网络不稳定情况下的重试
2. 测试无效URL的错误处理
3. 测试不支持的平台的错误提示
4. 验证3次重试后的错误信息

### 平台支持
- ✅ 抖音 (douyin)
- ✅ 哔哩哔哩 (bilibili)
- ✅ 快手 (kuaishou)

## 配置说明

重试次数硬编码为3次，如需修改：

```javascript
// 在 fetchVideo 方法中
const maxRetries = 3; // 修改这个值
```

重试延迟策略：

```javascript
// 当前策略：第N次失败后等待 N * 2 秒
const delayMs = attempt * 2000;

// 可以根据需要修改延迟策略，例如：
// 固定延迟：const delayMs = 3000;
// 指数退避：const delayMs = Math.pow(2, attempt) * 1000;
```

## 注意事项

1. **不再降级到后端**: 此版本移除了降级到后端抓取的逻辑，完全依赖前端 Puppeteer 抓取
2. **浏览器资源**: 每次重试都会创建新的浏览器页面，确保环境干净
3. **缓存机制**: 只有成功抓取的结果才会被缓存
4. **任务管理**: 每次重试都会清理上一次的任务记录

## 后续优化建议

1. 将重试次数和延迟策略作为配置项
2. 添加不同错误类型的智能重试策略（如网络错误可重试，平台不支持则不重试）
3. 考虑添加熔断机制，避免某个视频持续失败影响整体服务
4. 添加重试成功率的统计和监控

